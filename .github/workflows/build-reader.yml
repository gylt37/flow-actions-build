name: 编译 Flow Reader

on:
  workflow_dispatch: # 仅手动触发方式

permissions:
  contents: read
  actions: read

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      # 以下所有步骤完全复制原文件，未做任何修改（包括缓存逻辑）
      - name: Checkout 代码库
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: 安装 pnpm
        run: |
          npm install -g pnpm
          pnpm --version

      - name: 启用 Corepack 并验证环境
        run: |
          corepack enable
          which pnpm
          pnpm config set store-dir ~/.pnpm-store

      - name: Turbo Prune 提取 Reader 相关依赖/代码
        run: |
          rm -rf out
          npx turbo@latest prune --scope=@flow/reader --docker

      - name: 创建构建目录并复制依赖文件
        run: |
          mkdir -p ~/flow-build
          cp -r out/json/* ~/flow-build/
          cp -r out/pnpm-* ~/flow-build/ || true

      - name: 安装依赖（构建目录）
        run: |
          cd ~/flow-build
          pnpm install --frozen-lockfile --store-dir ~/.pnpm-store

      - name: 复制源码/配置文件到构建目录
        run: |
          cp -r out/full/* ~/flow-build/
          cp -r turbo.json ~/flow-build/
          cp -r tsconfig*.json ~/flow-build/ || true

      - name: 构建 Reader（Standalone 模式）
        run: |
          cd ~/flow-build
          DOCKER=1 pnpm -F reader build

      - name: 创建产物目录并复制 Standalone 产物
        run: |
          mkdir -p ~/flow-reader
          cp -r ~/flow-build/apps/reader/next.config.js ~/flow-reader/
          cp -r ~/flow-build/apps/reader/package.json ~/flow-reader/
          cp -r ~/flow-build/apps/reader/.next/standalone/* ~/flow-reader/
          mkdir -p ~/flow-reader/apps/reader/.next/static
          cp -r ~/flow-build/apps/reader/.next/static/* ~/flow-reader/apps/reader/.next/static/

      - name: 用 tar 打包整个产物目录
        run: |
          # 仅在打包文件名中新增架构标识，避免覆盖，其余打包逻辑不变
          tar -cpzvf ~/flow-reader.tar.gz -C ~ flow-reader

      - name: 上传产物到 GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          # Artifact名称新增架构标识，便于区分
          name: flow-reader
          path: ~/flow-reader.tar.gz
          retention-days: 2
          if-no-files-found: error
